<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">code{white-space: pre;}</style>
  <link rel="stylesheet" href="//chmd.fr/style.css" type="text/css" />
</head>
<body>
<h1 id="lighttpd-external-auth">Lighttpd external-auth</h1>
<h2 id="summary">Summary</h2>
<p><a href="https://git.chmd.fr/?p=lighttpd-external-auth.git;a=blob_plain;f=external-auth.lua">external-auth.lua</a> is a lighttpd magnet script:</p>
<ul>
<li>Originally written for openid</li>
<li>Providing access control via openid, oauth and the likes</li>
<li>Allowing per-user filtering</li>
<li>Protecting static content / web apps unaware of security otherwise</li>
</ul>
<h2 id="demos">Demos</h2>
<ul>
<li><a href="/demo1">demo 1</a>: This page is protected by a lame login page. POST-ing &quot;login=Guest&quot; signs you on as &quot;Guest&quot;, and POST-ing &quot;logout=logout&quot; signs you off.</li>
<li><a href="/demo2">demo 2</a>: This page demonstrates per-user access control. You cannot login as &quot;Guest&quot;, but you can do it as &quot;VIP&quot;.</li>
<li><a href="/demo3">demo 3</a>: Before trying this one, you should <a href="https://login.chmd.fr/?logout=true">logout</a>, because no access control will performed. Then come back and visit the link. Before accessing it, you will be presented with a nice login page that actually performs some openid/oauth checks.</li>
</ul>
<h2 id="sourcelicense">Source/License</h2>
<p>Source available at <a href="https://git.chmd.fr/?p=lighttpd-external-auth.git">git.chmd.fr</a>, mirrored on <a href="https://github.com/chmduquesne/lighttpd-external-auth">github</a>.</p>
<pre><code>git clone https://git.chmd.fr/lighttpd-external-auth.git</code></pre>
<p>License MIT</p>
<h2 id="work-flow">Work Flow</h2>
<ol style="list-style-type: decimal">
<li>The user tries to access protected content. The magnet script intercepts the request and checks for a username and an authentication token in the user's cookies. As no authentication has occurred yet, this fails and the user is redirected to a login page.</li>
<li>On the login page, the user goes through an authentication process. This part has actually nothing to do with this script. The only thing that matters is that, at the end of this authentication process, when the authentication is successful, the login page sets the appropriate username and authentication token in the cookies of the user's browser, and then redirects the user to the original url.</li>
<li>This time, when the script checks, it finds the username and the authentication token in the user's cookies. It checks that the token is valid, then checks that this username is allowed to access the content. If both conditions are satisfied, the script stops there and lets lighttpd deliver the content normally.</li>
</ol>
<p>The authentication token that is mentioned in this work flow is a hmac-sha1 signature, where the message to be signed is the username appended with a timestamp (the user will be allowed to access the content only within the time window where this timestamp is considered valid), and the secret is a random string that is shared between the magnet and the login page. This random string is initialized when the magnet script is loaded for the first time and is stored in a file, such that the login page can read it. Obviously, this means that the login page has to be hosted to be on the same lighttpd server, so that it can read the shared secret.</p>
<h2 id="howto-demo1-the-basics">Howto demo1: The basics</h2>
<ol style="list-style-type: decimal">
<li><p>Install <a href="https://git.chmd.fr/?p=lighttpd-external-auth.git;a=blob_plain;f=external-auth.lua">external-auth.lua</a>. We will copy it to <code>/etc/lighttpd/lua/external-auth.lua</code>, but any path readable by lighttpd would work.</p></li>
<li><p>Install the lua dependencies. On debian:</p>
<pre><code>sudo aptitude install luarocks
sudo luarocks install luacrypto</code></pre></li>
<li><p>Activate <code>mod_setenv</code> and <code>mod_magnet</code> in <code>/etc/lighttpd/lighttpd.conf</code></p>
<pre><code>server.modules = (
    ...
    &quot;mod_setenv&quot;,
    &quot;mod_magnet&quot;,
    ...
)</code></pre></li>
<li><p>Put the content you want to protect in a conditional. Here, we are going to protect every url starting with <a href="https://lighttpd-external-auth.chmd.fr/demo1">http://lighttpd-external-auth.chmd.fr/demo1</a>. To do so, we load the script with <code>magnet.attract-physical-path-to</code> in the conditional:</p>
<pre><code>$HTTP[&quot;host&quot;] == &quot;lighttpd-external-auth.chmd.fr&quot; {
    # Set the document root
    server.document-root = &quot;/home/www/sites/lighttpd-external-auth.chmd.fr/&quot;
    # Conditional where we load the script
    $HTTP[&quot;url&quot;] =~ &quot;/demo1.*&quot; {
            magnet.attract-physical-path-to = (
            &quot;/etc/lighttpd/lua/external-auth.lua&quot; )
        }
    }
    ...
}</code></pre></li>
<li><p>We need to set up an authentication page. By default, the script redirects unauthenticated users to the page <code>/login.php</code>. For now, we will follow these defaults. We will first copy the file <a href="https://git.chmd.fr/?p=lighttpd-external-auth.git;a=blob_plain;f=magnet.php">magnet.php</a> to the document-root. Then, we edit <code>login.php</code>, the page that actually performs the login.</p>
<pre><code>&lt;?php
// We need the functions in the script &#39;magnet.php&#39;, that we installed
// along with our login page
require_once(&#39;magnet.php&#39;);

// If we receive a POST &quot;login=Guest&quot;, the login is performed
if (isset($_POST[&quot;login&quot;])){
    if ($_POST[&quot;login&quot;] == &quot;Guest&quot;) {
        magnet_authentify(&quot;Guest&quot;);
    }
    if (isset($_GET[&quot;orig_url&quot;])) {
        $orig_url = $_GET[&quot;orig_url&quot;];
        if (matches_domain($orig_url)) {
            header(&quot;Location: $orig_url&quot;);
        }
    }
}
// If the users POSTs logout, the logout is performed
else {
    if (isset($_POST[&quot;logout&quot;])){
        magnet_deauthentify();
    }
}
// The rest is just html with two buttons, login and logout, that POST
// the appropriate values.
?&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;login&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;/form&gt;
    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;button name=&quot;login&quot; value=&quot;Guest&quot;&gt;login as &quot;Guest&quot;&lt;/button&gt;
    &lt;form&gt;
    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;button name=&quot;logout&quot; value=&quot;logout&quot;&gt;logout&lt;/button&gt;
    &lt;form&gt;
&lt;/body&gt;</code></pre></li>
</ol>
<p>That is it!</p>
<h2 id="howto-demo2-access-control">Howto demo2: Access Control</h2>
<p>The next step will be about limiting the access to some users. We now want to protect the urls starting with <a href="/demo2">http://lighttpd-external-auth.chmd.fr/demo2</a>, and give access to &quot;VIP&quot;, but not to &quot;Guest&quot;. This is done by having the script load extra lua code. To tell the script what lua code to load, we use environment variables.</p>
<ol style="list-style-type: decimal">
<li><p>Make a second lighttpd conditional for filtering demo2, and load the script with <code>magnet-attract-physical-path-to</code>:</p>
<pre><code>$HTTP[&quot;host&quot;] == &quot;lighttpd-external-auth.chmd.fr&quot; {
...
    $HTTP[&quot;url&quot;] =~ &quot;/demo2.*&quot; {
        $HTTP[&quot;url&quot;] != &quot;/demo2/login.php&quot; {
            magnet.attract-physical-path-to = (
            &quot;/etc/lighttpd/lua/external-auth.lua&quot; )
        }
    }</code></pre></li>
<li><p>BEFORE loading the script, set the environment variable <code>EXTERNAL_AUTH_CONFIG</code> to tell the script where to load our extra lua code from. We will put the code in the file <code>/etc/lighttpd/lua/external-auth/demo2.lighttpd-external-auth.chmd.fr.lua</code></p>
<pre><code>$HTTP[&quot;host&quot;] == &quot;lighttpd-external-auth.chmd.fr&quot; {
...
    $HTTP[&quot;url&quot;] =~ &quot;/demo2.*&quot; {
        $HTTP[&quot;url&quot;] != &quot;/demo2/login.php&quot; {
            setenv.add-environment = ( &quot;EXTERNAL_AUTH_CONFIG&quot; =&gt;
            &quot;/etc/lighttpd/lua/external-auth/demo2.lighttpd-external-auth.chmd.fr.lua&quot; )
            magnet.attract-physical-path-to = (
            &quot;/etc/lighttpd/lua/external-auth.lua&quot; )
        }
    }</code></pre></li>
<li><p>Edit <code>/etc/lighttpd/lua/external-auth/demo2.lighttpd-external-auth.chmd.fr.lua</code>. There are mainly two settings that are interesting to modify: the location of the login page, and the user authorized to see the content. We are interested in the latter. Basically, if we don't specify anything, everyone is authorize. However, if we want to filter users, we initialize <code>config[&quot;authorized_identities&quot;]</code> to an empty table, and then we set <code>config[&quot;authorized_identities&quot;][&quot;VIP&quot;]</code> to <code>true</code>. This has the effect of authorizing the user &quot;VIP&quot; (and only this user) to see the content protected by the script.</p>
<pre><code>config[&quot;authorized_identities&quot;] = { }
config[&quot;authorized_identities&quot;][&quot;VIP&quot;] = true</code></pre></li>
<li><p>Since we can choose another location for the login page, let us put it in <code>/demo2/login.php</code>. Edit <code>/etc/lighttpd/lua/external-auth/demo2.lighttpd-external-auth.chmd.fr.lua</code> and assign the variable <code>config[&quot;login_url&quot;]</code>:</p>
<pre><code>config[&quot;login_url&quot;] = &quot;/demo2/login.php&quot;
config[&quot;authorized_identities&quot;] = { }
config[&quot;authorized_identities&quot;][&quot;VIP&quot;] = true</code></pre></li>
<li><p>We have to be careful not to place the login page in an unreachable place. Edit <code>/etc/lighttpd/lighttpd.conf</code>, and modify the conditional such that this page is reachable:</p>
<pre><code>$HTTP[&quot;host&quot;] == &quot;lighttpd-external-auth.chmd.fr&quot; {
    ...
    $HTTP[&quot;url&quot;] =~ &quot;/demo2.*&quot; {
        # make an exception for &quot;/demo2/login.php&quot;
        $HTTP[&quot;url&quot;] != &quot;/demo2/login.php&quot; {
            setenv.add-environment = ( &quot;EXTERNAL_AUTH_CONFIG&quot; =&gt;
            &quot;/etc/lighttpd/lua/external-auth/demo2.lighttpd-external-auth.chmd.fr.lua&quot; )
            magnet.attract-physical-path-to = (
            &quot;/etc/lighttpd/lua/external-auth.lua&quot; )
        }
    }</code></pre></li>
<li><p>Last, create the login page <code>/demo2/login.php</code> (don't forget to copy <code>magnet.php</code> in <code>demo2/</code>)</p>
<pre><code>&lt;?php
// We need the functions in the script &#39;magnet.php&#39;, that we installed
// along with our login page
require_once(&#39;magnet.php&#39;);

if (isset($_POST[&quot;login&quot;])){
    // If we receive POST &quot;login=Guest&quot;, we login as Guest
    if ($_POST[&quot;login&quot;] == &quot;Guest&quot;) {
        magnet_authentify(&quot;Guest&quot;);
    }
    // If we receive POST &quot;login=VIP&quot;, we login as VIP
    if ($_POST[&quot;login&quot;] == &quot;VIP&quot;) {
        magnet_authentify(&quot;VIP&quot;);
    }
    if (isset($_GET[&quot;orig_url&quot;])) {
        $orig_url = $_GET[&quot;orig_url&quot;];
        if (matches_domain($orig_url)) {
            header(&quot;Location: $orig_url&quot;);
        }
    }
}
// If we receive POST logout, the logout is performed
else {
    if (isset($_POST[&quot;logout&quot;])){
        magnet_deauthentify();
    }
}
// The rest is just html with two buttons, login and logout, that POST
// the appropriate values.
?&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;login&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;/form&gt;
    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;button name=&quot;login&quot; value=&quot;Guest&quot;&gt;login as &quot;Guest&quot;&lt;/button&gt;
    &lt;form&gt;
    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;button name=&quot;login&quot; value=&quot;VIP&quot;&gt;login as &quot;VIP&quot;&lt;/button&gt;
    &lt;form&gt;
    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;button name=&quot;logout&quot; value=&quot;logout&quot;&gt;logout&lt;/button&gt;
    &lt;form&gt;
&lt;/body&gt;</code></pre></li>
</ol>
<p>Done!</p>
<h2 id="howto-demo3-real-openidoauth">Howto demo3: real openid/oauth</h2>
<p>Ok, so we have written lame login pages. What about openid and oauth? As you might expect, login pages can get a little bit fancy and complicated, so we will not get into many details. This project provides such a login page (a copy of the one that lives on <a href="https://login.chmd.fr">login.chmd.fr</a>). It protects <a href="/demo3">demo3</a> How to set it up is explained in the README files of <a href="https://git.chmd.fr/?p=lighttpd-external-auth.git;a=tree;f=example-loginpage">example-loginpage</a>. We will just quickly give the configuration:</p>
<ol style="list-style-type: decimal">
<li><p><code>/etc/lighttpd/lighttpd.conf</code></p>
<pre><code>$HTTP[&quot;host&quot;] == &quot;lighttpd-external-auth.chmd.fr&quot; {
    ...
    $HTTP[&quot;url&quot;] =~ &quot;/demo3.*&quot; {
        setenv.add-environment = ( &quot;EXTERNAL_AUTH_CONFIG&quot; =&gt;
        &quot;/etc/lighttpd/lua/external-auth/demo3.lighttpd-external-auth.chmd.fr.lua&quot; )
        magnet.attract-physical-path-to = (
        &quot;/etc/lighttpd/lua/external-auth.lua&quot; )
    }
}</code></pre></li>
<li><p><code>/etc/lighttpd/lua/external-auth/demo3.lighttpd-external-auth.chmd.fr.lua</code></p>
<pre><code>config[&quot;login_url&quot;] = &quot;https://login.chmd.fr&quot;</code></pre></li>
</ol>
<h2 id="conclusion">Conclusion</h2>
<p>Have fun with this!</p>
<div class="comments">
<h2>
Comments
</h2>
    <script id='fbnrl3e'>(function(i){var f,s=document.getElementById(i);f=document.createElement('iframe');f.src='//api.flattr.com/button/view/?uid=chmd&button=compact&url='+encodeURIComponent(document.URL);f.title='Flattr';f.height=20;f.width=110;f.style.borderWidth=0;s.parentNode.insertBefore(f,s);})('fbnrl3e');</script>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_identifier = "lighttpd-external-auth.chmd.fr";
        (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//chmd.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
</div>
</body>
</html>
