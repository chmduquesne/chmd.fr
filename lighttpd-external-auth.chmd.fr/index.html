<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <link rel="stylesheet" href="https://hpass.chmd.fr/style.css" type="text/css" />
</head>
<body>
<h1 id="lighttpd-external-auth">Lighttpd external-auth</h1>
<h2 id="summary">Summary</h2>
<p><a href="https://git.chmd.fr/?p=lighttpd-external-auth;a=blob_plain;f=external-auth.lua;hb=HEAD">external-auth.lua</a> is a lighttpd lua magnet script:</p>
<ul>
<li>Originally written for openid</li>
<li>Providing access control via openid, oauth and the likes</li>
<li>Protecting static content / web apps unaware of security otherwise</li>
</ul>
<h2 id="demos">Demos</h2>
<ul>
<li><a href="/demo1">demo 1</a>: This page is protected by a lame login page. POST-ing &quot;login=Guest&quot; signs you on as &quot;Guest&quot;, and POST-ing &quot;logout=logout&quot; signs you off.</li>
<li><a href="/demo2">demo 2</a>: This page demonstrates per-user access control. You cannot login as &quot;Guest&quot;, but you can do it as &quot;VIP&quot;.</li>
<li><a href="/demo3">demo 3</a>: Before trying this one, you should <a href="https://login.chmd.fr/?logout=true">logout</a>, because no access control will performed. It presents you with a nice login page that actually performs some openid/oauth checks.</li>
</ul>
<h2 id="sourcelicense">Source/License</h2>
<p>Source available at <a href="https://git.chmd.fr/?p=lighttpd-external-auth">git.chmd.fr</a>, mirrored on <a href="https://github.com/chmduquesne/lighttpd-external-auth">github</a>.</p>
<pre><code>git clone https://git.chmd.fr/lighttpd-external-auth</code></pre>
<p>License MIT</p>
<h2 id="how-does-this-work">How does this work?</h2>
<p>Here is the basic work flow:</p>
<ol style="list-style-type: decimal">
<li>The user tries to access protected content. The magnet script intercepts the request and checks for a username and an authentication token in the user's cookies. As no authentication has occurred yet, this fails and the user is redirected to a login page.</li>
<li>On the login page, the user goes through an authentication process. This part has actually nothing to do with this script. The only thing that matters is that, at the end of this authentication process, when the authentication is successful, the login page sets the appropriate username and authentication token in the cookies of the user's browser, and then redirects the user to the original url.</li>
<li>This time, when the script checks, it finds the username and the authentication token in the user's cookies. It checks that the token is valid, then checks that this username is allowed to access the content. If both conditions are satisfied, the script stops there and lets lighttpd deliver the content normally.</li>
</ol>
<p>The authentication token that is mentioned in this work flow is a hmac-sha1 signature, where the message to be signed is the username appended with a timestamp (the user will be allowed to access the content only within the time window where this timestamp is considered valid), and the secret is a random string that is shared between the magnet and the login page. This random string is initialized when the magnet script is loaded for the first time and is stored in a file, such that the login page can read it. Obviously, this means that the login page has somehow to be on the same lighttpd server.</p>
<h2 id="howto-demo1-the-basics">Howto demo1: The basics</h2>
<ol style="list-style-type: decimal">
<li><p>You first need to install the script <a href="https://git.chmd.fr/?p=lighttpd-external-auth;a=blob_plain;f=external-auth.lua;hb=HEAD">external-auth.lua</a>. We will copy it to <code>/etc/lighttpd/lua/external-auth.lua</code>, but any path readable by lighttpd would work.</p></li>
<li><p>Then, activate <code>mod_setenv</code> and <code>mod_magnet</code> in <code>/etc/lighttpd/lighttpd.conf</code></p>
<pre><code>server.modules = (
    ...
    &quot;mod_setenv&quot;,
    &quot;mod_magnet&quot;,
    ...
)</code></pre></li>
<li><p>Put the content you want to protect in a conditional. Here, we are going to protect every url starting with <a href="https://lighttpd-external-auth.chmd.fr/demo1">http://lighttpd-external-auth.chmd.fr/demo1</a>. To do so, we load the script with <code>magnet.attract-physical-path-to</code> in the conditional.</p>
<pre><code>$HTTP[&quot;host&quot;] == &quot;lighttpd-external-auth.chmd.fr&quot; {
    server.document-root = &quot;/home/www/sites/lighttpd-external-auth.chmd.fr/&quot;
    $HTTP[&quot;url&quot;] =~ &quot;/demo1.*&quot; {
            magnet.attract-physical-path-to = (
            &quot;/etc/lighttpd/lua/external-auth.lua&quot; )
        }
    }
    ...
}</code></pre></li>
<li><p>We need to set up an authentication page. By default, the script redirects unauthenticated users to the page <code>/login.php</code>. For now, we will follow these defaults. We will first copy the file <a href="https://git.chmd.fr/?p=lighttpd-external-auth;a=blob_plain;f=magnet.php;hb=839424ae7fa7a83018d81f56c9a142bb4fb6b006">magnet.php</a> to the document-root.</p></li>
<li><p>We now edit <code>login.php</code>, the page that actually performs the login.</p>
<pre><code>&lt;?php
// We need the functions in the script &#39;magnet.php&#39;, that we installed
// along with our login page
require_once(&#39;magnet.php&#39;);

// If we receive a POST &quot;login=Guest&quot;, the login is performed
if (isset($_POST[&quot;login&quot;])){
    if ($_POST[&quot;login&quot;] == &quot;Guest&quot;) {
        magnet_authentify(&quot;Guest&quot;);
    }
    if (isset($_GET[&quot;orig_url&quot;])) {
        $orig_url = $_GET[&quot;orig_url&quot;];
        if (matches_domain($orig_url)) {
            header(&quot;Location: $orig_url&quot;);
        }
    }
}
// If the users POSTs logout, the logout is performed
else {
    if (isset($_POST[&quot;logout&quot;])){
        magnet_deauthentify();
    }
}
// The rest is just html with two buttons, login and logout, that POST
// the appropriate values.
?&gt;

&lt;html&gt;
&lt;head&gt;
    &lt;meta charset=&quot;utf-8&quot;&gt;
    &lt;title&gt;login&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;/form&gt;
    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;button name=&quot;login&quot; value=&quot;Guest&quot;&gt;login as &quot;Guest&quot;&lt;/button&gt;
    &lt;form&gt;
    &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
        &lt;button name=&quot;logout&quot; value=&quot;logout&quot;&gt;logout&lt;/button&gt;
    &lt;form&gt;
&lt;/body&gt;</code></pre></li>
<li><p>That is it! You can now try to visit <a href="/demo1">demo1</a>. You should be redirected to your first login page.</p></li>
</ol>
<h2 id="howto-demo2-access-control">Howto demo2: Access Control</h2>
<p>The next step will be about limiting the access to some users. We now want to protect the urls starting with <a href="/demo2">http://lighttpd-external-auth.chmd.fr/demo2</a>.</p>
</body>
</html>
